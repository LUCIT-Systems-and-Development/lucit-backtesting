<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>backtesting.backtesting &#8212; lucit-backtesting 1.0.0 documentation</title><meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=92fd9be5" />
    <link rel="stylesheet" type="text/css" href="../../_static/pydoctheme.css?v=fdf8e9ae" />
    
    <script src="../../_static/documentation_options.js?v=6efca38a"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /><link rel="shortcut icon" type="image/png" href="../../_static/lucit.png" />
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    
    <script
        src='//eu.fw-cdn.com/10659511/361973.js'
        chat='true'>
    </script>
    
            <script type="text/javascript" src="../../_static/copybutton.js"></script>
            <script type="text/javascript" src="../../_static/menu.js"></script> 
  </head>
<body>
<div class="mobile-nav">
    <input type="checkbox" id="menuToggler" class="toggler__input" aria-controls="navigation"
           aria-pressed="false" aria-expanded="false" role="button" aria-label="Menu" />
    <label for="menuToggler" class="toggler__label">
        <span></span>
    </label>
    <nav class="nav-content" role="navigation">
        <form role="search" class="search" action="../../search.html" method="get">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" class="search-icon">
                <path fill-rule="nonzero"
                        d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 001.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 00-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 005.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="#444"></path>
            </svg>
            <input type="text" name="q" aria-label="Quick search"/>
            <input type="submit" value="Go"/>
        </form>
    </nav>
    <div class="menu-wrapper">
        <nav class="menu" role="navigation" aria-label="main navigation">
            <p class="logo">
                <div style="text-align: center;">
                    <a href="https://www.lucit.tech"><img src="https://www.lucit.tech/files/images/logos/LUCIT-LOGO.png"></a><br>
                    <a href="https://shop.lucit.services/software/unicorn-binance-suite" style="font-size: 0.85em;font-weight: 900">Get a UNICORN Binance Suite License!</a><br>
                    <br>
                    <a href="https://github.com/LUCIT-Systems-and-Development" target="_blank" style="text-decoration:none;"><img src="../../_static/icons8-github-20.png"></a>
                    <a href="https://fb.me/lucit.systems.and.development" target="_blank" style="text-decoration:none;"><img src="../../_static/icons8-facebook-20.png"></a>
                    <a href="https://twitter.com/LUCIT_SysDev" target="_blank" style="text-decoration:none;"><img src="../../_static/icons8-twitter-20.png"></a>
                    <a href="https://www.linkedin.com/company/lucit-systems-and-development" target="_blank" style="text-decoration:none;"><img src="../../_static/icons8-linkedin-20.png"></a>
                    <a href="https://www.xing.com/pages/lucit-systems-and-development" target="_blank" style="text-decoration:none;"><img src="../../_static/icons8-xing-20.png"></a>
                    <a href="https://medium.lucit.tech" target="_blank" style="text-decoration:none;"><img src="../../_static/icons8-medium-monogram-20.png"></a>
                    <a href="https://www.youtube.com/channel/UCp57u8vaPqEWQTlfpYn-KnQ" target="_blank" style="text-decoration:none;"><img src="../../_static/icons8-youtube-20.png"></a>
                </div>
            </p>
<div id="searchbox" style="display: block" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<div role="note" aria-label="source code">
    <h3>GitHub</h3>
    <ul class="this-page-menu">
      <li><a href="https://github.com/LUCIT-Systems-and-Development/lucit-backtesting">Show Source</a></li>
      
<li>
<a class="github-button" href="https://github.com/LUCIT-Systems-and-Development/lucit-backtesting"
   data-icon="octicon-star" data-show-count="true"
   aria-label="Star LUCIT-Systems-and-Development/lucit-backtesting on GitHub">Star</a>
<br />
<a class="github-button" href="https://github.com/LUCIT-Systems-and-Development/lucit-backtesting/subscription"
   data-icon="octicon-eye" data-show-count="true"
   aria-label="Watch LUCIT-Systems-and-Development/lucit-backtesting on GitHub">Watch</a>
<br />
<a class="github-button" href="https://github.com/LUCIT-Systems-and-Development/lucit-backtesting/fork"
   data-icon="octicon-repo-forked" data-show-count="true"
   aria-label="Fork LUCIT-Systems-and-Development/lucit-backtesting on GitHub">Fork</a>
<br />
<a class="github-button" href="https://github.com/LUCIT-Systems-and-Development/lucit-backtesting/issues"
   data-icon="octicon-issue-opened"
   data-show-count="true" aria-label="Issue LUCIT-Systems-and-Development/lucit-backtesting on GitHub">Issue</a>
    
</li>

    </ul>
</div>
        </nav>
    </div>
</div>
  
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
              
                  
                  
              <li><img src="../../_static/lucit.png" alt="LUCIT Logo"
                       style="vertical-align: middle; margin-top: -1px"/></li>
              <li><a href="https://docs.lucit.tech">Docs Index</a> | </li>
              <li><a href="https://www.lucit.tech/lucit-backtesting.html">lucit-backtesting</a> &#187;</li>
                  
              
              
              <a href="../../index.html">Docs</a> &#187;
              
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">backtesting.backtesting</a></li>
                <li class="right">
                    

    <div class="inline-search" role="search">
        <form class="inline-search" action="../../search.html" method="get">
          <input placeholder="Quick search" aria-label="Quick search" type="text" name="q" />
          <input type="submit" value="Go" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </form>
    </div>
                     |
                </li>
            
      </ul>
    </div>    

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for backtesting.backtesting</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Core framework data structures.</span>
<span class="sd">Objects from this module can also be imported from the top-level</span>
<span class="sd">module directly, e.g.</span>

<span class="sd">    from backtesting import Backtest, Strategy</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span><span class="p">,</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">compress</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">repeat</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">copysign</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">default_rng</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span> <span class="k">as</span> <span class="n">_tqdm</span>
    <span class="n">_tqdm</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_tqdm</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">_tqdm</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">seq</span>

<span class="kn">from</span> <span class="nn">._plotting</span> <span class="kn">import</span> <span class="n">plot</span>  <span class="c1"># noqa: I001</span>
<span class="kn">from</span> <span class="nn">._stats</span> <span class="kn">import</span> <span class="n">compute_stats</span>
<span class="kn">from</span> <span class="nn">._util</span> <span class="kn">import</span> <span class="n">_as_str</span><span class="p">,</span> <span class="n">_Indicator</span><span class="p">,</span> <span class="n">_Data</span><span class="p">,</span> <span class="n">try_</span>

<span class="n">__pdoc__</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Strategy.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;Order.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;Position.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;Trade.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="Strategy">
<a class="viewcode-back" href="../../lucit_backtesting.html#backtesting.backtesting.Strategy">[docs]</a>
<span class="k">class</span> <span class="nc">Strategy</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A trading strategy base class. Extend this class and</span>
<span class="sd">    override methods</span>
<span class="sd">    `backtesting.backtesting.Strategy.init` and</span>
<span class="sd">    `backtesting.backtesting.Strategy.next` to define</span>
<span class="sd">    your own strategy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">broker</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indicators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="p">:</span> <span class="n">_Broker</span> <span class="o">=</span> <span class="n">broker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="n">_Data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Strategy &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                                        <span class="nb">map</span><span class="p">(</span><span class="n">_as_str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}{</span><span class="n">params</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="nf">_check_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Strategy &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; is missing parameter &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                    <span class="s2">&quot;Strategy class should define parameters as class variables before they &quot;</span>
                    <span class="s2">&quot;can be optimized or run with.&quot;</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">params</span>

<div class="viewcode-block" id="Strategy.I">
<a class="viewcode-back" href="../../lucit_backtesting.html#backtesting.backtesting.Strategy.I">[docs]</a>
    <span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="c1"># noqa: E743</span>
          <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
          <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
          <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Declare an indicator. An indicator is just an array of values,</span>
<span class="sd">        but one that is revealed gradually in</span>
<span class="sd">        `backtesting.backtesting.Strategy.next` much like</span>
<span class="sd">        `backtesting.backtesting.Strategy.data` is.</span>
<span class="sd">        Returns `np.ndarray` of indicator values.</span>

<span class="sd">        `func` is a function that returns the indicator array(s) of</span>
<span class="sd">        same length as `backtesting.backtesting.Strategy.data`.</span>

<span class="sd">        In the plot legend, the indicator is labeled with</span>
<span class="sd">        function name, unless `name` overrides it.</span>

<span class="sd">        If `plot` is `True`, the indicator is plotted on the resulting</span>
<span class="sd">        `backtesting.backtesting.Backtest.plot`.</span>

<span class="sd">        If `overlay` is `True`, the indicator is plotted overlaying the</span>
<span class="sd">        price candlestick chart (suitable e.g. for moving averages).</span>
<span class="sd">        If `False`, the indicator is plotted standalone below the</span>
<span class="sd">        candlestick chart. By default, a heuristic is used which decides</span>
<span class="sd">        correctly most of the time.</span>

<span class="sd">        `color` can be string hex RGB triplet or X11 color name.</span>
<span class="sd">        By default, the next available color is assigned.</span>

<span class="sd">        If `scatter` is `True`, the plotted indicator marker will be a</span>
<span class="sd">        circle instead of a connected line segment (default).</span>

<span class="sd">        Additional `*args` and `**kwargs` are passed to `func` and can</span>
<span class="sd">        be used for parameters.</span>

<span class="sd">        For example, using simple moving average function from TA-Lib:</span>

<span class="sd">            def init():</span>
<span class="sd">                self.sma = self.I(ta.SMA, self.data.Close, self.n_sma)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">_as_str</span><span class="p">,</span> <span class="n">chain</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()))))</span>
            <span class="n">func_name</span> <span class="o">=</span> <span class="n">_as_str</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">if</span> <span class="n">params</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="n">_as_str</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span>
                               <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="nb">map</span><span class="p">(</span><span class="n">_as_str</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()))))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Indicator &quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; error&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">try_</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">is_arraylike</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Optionally flip the array if the user returned e.g. `df.values`</span>
        <span class="k">if</span> <span class="n">is_arraylike</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">T</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_arraylike</span> <span class="ow">or</span> <span class="ow">not</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">value</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">Close</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Indicators must return (optionally a tuple of) numpy.arrays of same &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;length as `data` (data shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">Close</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">; indicator &quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;shape: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;shape&quot;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">, returned value: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">overlay</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">Close</span>
            <span class="c1"># By default, overlay if strong majority of indicator values</span>
            <span class="c1"># is within 30% of Close</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                <span class="n">overlay</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">1.4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mf">.6</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">.6</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">_Indicator</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="n">overlay</span><span class="p">,</span>
                           <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="n">scatter</span><span class="p">,</span>
                           <span class="c1"># _Indicator.s Series accessor uses this:</span>
                           <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indicators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="Strategy.init">
<a class="viewcode-back" href="../../lucit_backtesting.html#backtesting.backtesting.Strategy.init">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the strategy.</span>
<span class="sd">        Override this method.</span>
<span class="sd">        Declare indicators (with `backtesting.backtesting.Strategy.I`).</span>
<span class="sd">        Precompute what needs to be precomputed or can be precomputed</span>
<span class="sd">        in a vectorized fashion before the strategy starts.</span>

<span class="sd">        If you extend composable strategies from `backtesting.lib`,</span>
<span class="sd">        make sure to call:</span>

<span class="sd">            super().init()</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Strategy.next">
<a class="viewcode-back" href="../../lucit_backtesting.html#backtesting.backtesting.Strategy.next">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main strategy runtime method, called as each new</span>
<span class="sd">        `backtesting.backtesting.Strategy.data`</span>
<span class="sd">        instance (row; full candlestick bar) becomes available.</span>
<span class="sd">        This is the main method where strategy decisions</span>
<span class="sd">        upon data precomputed in `backtesting.backtesting.Strategy.init`</span>
<span class="sd">        take place.</span>

<span class="sd">        If you extend composable strategies from `backtesting.lib`,</span>
<span class="sd">        make sure to call:</span>

<span class="sd">            super().next()</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


    <span class="k">class</span> <span class="nc">__FULL_EQUITY</span><span class="p">(</span><span class="nb">float</span><span class="p">):</span>  <span class="c1"># noqa: N801</span>
        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;.9999&#39;</span>
    <span class="n">_FULL_EQUITY</span> <span class="o">=</span> <span class="n">__FULL_EQUITY</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span>

<div class="viewcode-block" id="Strategy.buy">
<a class="viewcode-back" href="../../lucit_backtesting.html#backtesting.backtesting.Strategy.buy">[docs]</a>
    <span class="k">def</span> <span class="nf">buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
            <span class="n">size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_FULL_EQUITY</span><span class="p">,</span>
            <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">sl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">tag</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Place a new long order. For explanation of parameters, see `Order` and its properties.</span>

<span class="sd">        See `Position.close()` and `Trade.close()` for closing existing positions.</span>

<span class="sd">        See also `Strategy.sell()`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">round</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span><span class="p">,</span> \
            <span class="s2">&quot;size must be a positive fraction of equity, or a positive whole number of units&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">new_order</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span></div>


<div class="viewcode-block" id="Strategy.sell">
<a class="viewcode-back" href="../../lucit_backtesting.html#backtesting.backtesting.Strategy.sell">[docs]</a>
    <span class="k">def</span> <span class="nf">sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
             <span class="n">size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_FULL_EQUITY</span><span class="p">,</span>
             <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">sl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">tag</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Place a new short order. For explanation of parameters, see `Order` and its properties.</span>

<span class="sd">        See also `Strategy.buy()`.</span>

<span class="sd">        .. note::</span>
<span class="sd">            If you merely want to close an existing long position,</span>
<span class="sd">            use `Position.close()` or `Trade.close()`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">round</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span><span class="p">,</span> \
            <span class="s2">&quot;size must be a positive fraction of equity, or a positive whole number of units&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">new_order</span><span class="p">(</span><span class="o">-</span><span class="n">size</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">equity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Current account equity (cash plus assets).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">equity</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Data</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Price data, roughly as passed into</span>
<span class="sd">        `backtesting.backtesting.Backtest.__init__`,</span>
<span class="sd">        but with two significant exceptions:</span>

<span class="sd">        * `data` is _not_ a DataFrame, but a custom structure</span>
<span class="sd">          that serves customized numpy arrays for reasons of performance</span>
<span class="sd">          and convenience. Besides OHLCV columns, `.index` and length,</span>
<span class="sd">          it offers `.pip` property, the smallest price unit of change.</span>
<span class="sd">        * Within `backtesting.backtesting.Strategy.init`, `data` arrays</span>
<span class="sd">          are available in full length, as passed into</span>
<span class="sd">          `backtesting.backtesting.Backtest.__init__`</span>
<span class="sd">          (for precomputing indicators and such). However, within</span>
<span class="sd">          `backtesting.backtesting.Strategy.next`, `data` arrays are</span>
<span class="sd">          only as long as the current iteration, simulating gradual</span>
<span class="sd">          price point revelation. In each call of</span>
<span class="sd">          `backtesting.backtesting.Strategy.next` (iteratively called by</span>
<span class="sd">          `backtesting.backtesting.Backtest` internally),</span>
<span class="sd">          the last array value (e.g. `data.Close[-1]`)</span>
<span class="sd">          is always the most recent value.</span>
<span class="sd">        * If you need data arrays (e.g. `data.Close`) to be indexed</span>
<span class="sd">          **Pandas series**, you can call their `.s` accessor</span>
<span class="sd">          (e.g. `data.Close.s`). If you need the whole of data</span>
<span class="sd">          as a **DataFrame**, use `.df` accessor (i.e. `data.df`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Position&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instance of `backtesting.backtesting.Position`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">position</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">orders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Tuple[Order, ...]&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of orders (see `Order`) waiting for execution.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_Orders</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">orders</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">trades</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Tuple[Trade, ...]&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of active trades (see `Trade`).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed_trades</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Tuple[Trade, ...]&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of settled trades (see `Trade`).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">closed_trades</span><span class="p">)</span></div>



<span class="k">class</span> <span class="nc">_Orders</span><span class="p">(</span><span class="nb">tuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: remove this class. Only for deprecation.</span>
    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancel all non-contingent (i.e. SL/TP) orders.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">order</span><span class="o">.</span><span class="n">is_contingent</span><span class="p">:</span>
                <span class="n">order</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="c1"># TODO: Warn on deprecations from the previous version. Remove in the next.</span>
        <span class="n">removed_attrs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;entry&#39;</span><span class="p">,</span> <span class="s1">&#39;set_entry&#39;</span><span class="p">,</span> <span class="s1">&#39;is_long&#39;</span><span class="p">,</span> <span class="s1">&#39;is_short&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;sl&#39;</span><span class="p">,</span> <span class="s1">&#39;tp&#39;</span><span class="p">,</span> <span class="s1">&#39;set_sl&#39;</span><span class="p">,</span> <span class="s1">&#39;set_tp&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">removed_attrs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Strategy.orders.</span><span class="si">{</span><span class="s2">&quot;/.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">removed_attrs</span><span class="p">)</span><span class="si">}</span><span class="s1"> were removed in&#39;</span>
                                 <span class="s1">&#39;Backtesting 0.2.0. &#39;</span>
                                 <span class="s1">&#39;Use `Order` API instead. See docs.&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;tuple&#39; object has no attribute </span><span class="si">{</span><span class="n">item</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="Position">
<a class="viewcode-back" href="../../lucit_backtesting.html#backtesting.backtesting.Position">[docs]</a>
<span class="k">class</span> <span class="nc">Position</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Currently held asset position, available as</span>
<span class="sd">    `backtesting.backtesting.Strategy.position` within</span>
<span class="sd">    `backtesting.backtesting.Strategy.next`.</span>
<span class="sd">    Can be used in boolean contexts, e.g.</span>

<span class="sd">        if self.position:</span>
<span class="sd">            ...  # we have a position, either long or short</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">broker</span><span class="p">:</span> <span class="s1">&#39;_Broker&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span> <span class="o">=</span> <span class="n">broker</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Position size in units of asset. Negative if position is short.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Profit (positive) or loss (negative) of the current position in cash units.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">pl</span> <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pl_pct</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Profit (positive) or loss (negative) of the current position in percent.&quot;&quot;&quot;</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">([</span><span class="n">trade</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">trades</span><span class="p">])</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">pl_pcts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">trade</span><span class="o">.</span><span class="n">pl_pct</span> <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">trades</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">pl_pcts</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_long</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if the position is long (position size is positive).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_short</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if the position is short (position size is negative).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span>

<div class="viewcode-block" id="Position.close">
<a class="viewcode-back" href="../../lucit_backtesting.html#backtesting.backtesting.Position.close">[docs]</a>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portion</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close portion of position by closing `portion` of each active trade. See `Trade.close`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
            <span class="n">trade</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">portion</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;Position: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span><span class="si">}</span><span class="s1"> trades)&gt;&#39;</span></div>



<span class="k">class</span> <span class="nc">_OutOfMoneyError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="Order">
<a class="viewcode-back" href="../../lucit_backtesting.html#backtesting.backtesting.Order">[docs]</a>
<span class="k">class</span> <span class="nc">Order</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Place new orders through `Strategy.buy()` and `Strategy.sell()`.</span>
<span class="sd">    Query existing orders through `Strategy.orders`.</span>

<span class="sd">    When an order is executed or [filled], it results in a `Trade`.</span>

<span class="sd">    If you wish to modify aspects of a placed but not yet filled order,</span>
<span class="sd">    cancel it and place a new one instead.</span>

<span class="sd">    All placed orders are [Good &#39;Til Canceled].</span>

<span class="sd">    `filled&lt;https://www.investopedia.com/terms/f/fill.asp&gt;`__</span>
<span class="sd">    `Good &#39;Til Canceled&lt;https://www.investopedia.com/terms/g/gtc.asp&gt;`__</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">broker</span><span class="p">:</span> <span class="s1">&#39;_Broker&#39;</span><span class="p">,</span>
                 <span class="n">size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">limit_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">stop_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">sl_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">tp_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">parent_trade</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;Trade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">tag</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span> <span class="o">=</span> <span class="n">broker</span>
        <span class="k">assert</span> <span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__limit_price</span> <span class="o">=</span> <span class="n">limit_price</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__stop_price</span> <span class="o">=</span> <span class="n">stop_price</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sl_price</span> <span class="o">=</span> <span class="n">sl_price</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tp_price</span> <span class="o">=</span> <span class="n">tp_price</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__parent_trade</span> <span class="o">=</span> <span class="n">parent_trade</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tag</span> <span class="o">=</span> <span class="n">tag</span>

    <span class="k">def</span> <span class="nf">_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s1">__</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Order </span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                                             <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span>
                                                 <span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span><span class="p">),</span>
                                                 <span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__limit_price</span><span class="p">),</span>
                                                 <span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stop_price</span><span class="p">),</span>
                                                 <span class="p">(</span><span class="s1">&#39;sl&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sl_price</span><span class="p">),</span>
                                                 <span class="p">(</span><span class="s1">&#39;tp&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tp_price</span><span class="p">),</span>
                                                 <span class="p">(</span><span class="s1">&#39;contingent&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contingent</span><span class="p">),</span>
                                                 <span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tag</span><span class="p">),</span>
                                             <span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>

<div class="viewcode-block" id="Order.cancel">
<a class="viewcode-back" href="../../lucit_backtesting.html#backtesting.backtesting.Order.cancel">[docs]</a>
    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancel the order.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">trade</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parent_trade</span>
        <span class="k">if</span> <span class="n">trade</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">trade</span><span class="o">.</span><span class="n">_sl_order</span><span class="p">:</span>
                <span class="n">trade</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">sl_order</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">trade</span><span class="o">.</span><span class="n">_tp_order</span><span class="p">:</span>
                <span class="n">trade</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">tp_order</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># XXX: https://github.com/kernc/backtesting.py/issues/251#issuecomment-835634984 ???</span>
                <span class="k">assert</span> <span class="kc">False</span></div>


    <span class="c1"># Fields getters</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Order size (negative for short orders).</span>

<span class="sd">        If size is a value between 0 and 1, it is interpreted as a fraction of current</span>
<span class="sd">        available liquidity (cash plus `Position.pl` minus used margin).</span>
<span class="sd">        A value greater than or equal to 1 indicates an absolute number of units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">limit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Order limit price for `limit orders&lt;https://www.investopedia.com/terms/l/limitorder.asp&gt;`__, or None</span>
<span class="sd">        for `market orders&lt;https://www.investopedia.com/terms/m/marketorder.asp&gt;`__, which are filled at next</span>
<span class="sd">        available price.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__limit_price</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Order stop price for</span>
<span class="sd">        `stop-limit/stop-market order&lt;https://www.investopedia.com/terms/s/stoporder.asp&gt;`__,</span>
<span class="sd">        otherwise None if no stop was set, or the stop price has already been hit.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stop_price</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A stop-loss price at which, if set, a new contingent stop-market order</span>
<span class="sd">        will be placed upon the `Trade` following this order&#39;s execution.</span>
<span class="sd">        See also `Trade.sl`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sl_price</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A take-profit price at which, if set, a new contingent limit order</span>
<span class="sd">        will be placed upon the `Trade` following this order&#39;s execution.</span>
<span class="sd">        See also `Trade.tp`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tp_price</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parent_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parent_trade</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arbitrary value (such as a string) which, if set, enables tracking</span>
<span class="sd">        of this order and the associated `Trade` (see `Trade.tag`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tag</span>

    <span class="n">__pdoc__</span><span class="p">[</span><span class="s1">&#39;Order.parent_trade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Extra properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_long</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if the order is long (order size is positive).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_short</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if the order is short (order size is negative).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">&lt;</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_contingent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True for `contingent&lt;https://www.investopedia.com/terms/c/contingentorder.asp&gt;`__ orders, i.e.</span>
<span class="sd">        `OCO&lt;https://www.investopedia.com/terms/o/oco.asp&gt;`__ stop-loss and take-profit bracket orders</span>
<span class="sd">        placed upon an active trade. Remaining contingent orders are canceled when their parent `Trade` is closed.</span>

<span class="sd">        You can modify contingent orders through `Trade.sl` and `Trade.tp`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parent_trade</span><span class="p">)</span></div>



<div class="viewcode-block" id="Trade">
<a class="viewcode-back" href="../../lucit_backtesting.html#backtesting.backtesting.Trade">[docs]</a>
<span class="k">class</span> <span class="nc">Trade</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    When an `Order` is filled, it results in an active `Trade`.</span>
<span class="sd">    Find active trades in `Strategy.trades` and closed, settled trades in `Strategy.closed_trades`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">broker</span><span class="p">:</span> <span class="s1">&#39;_Broker&#39;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">entry_bar</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span> <span class="o">=</span> <span class="n">broker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__entry_price</span> <span class="o">=</span> <span class="n">entry_price</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__exit_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__entry_bar</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">entry_bar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__exit_bar</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sl_order</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tp_order</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tag</span> <span class="o">=</span> <span class="n">tag</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;Trade size=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__size</span><span class="si">}</span><span class="s1"> time=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__entry_bar</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__exit_bar</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1"> &#39;</span> \
               <span class="sa">f</span><span class="s1">&#39;price=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__entry_price</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__exit_price</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1"> pl=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pl</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span> \
               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot; tag=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tag</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">__tag</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="nf">_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s1">__</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="Trade.close">
<a class="viewcode-back" href="../../lucit_backtesting.html#backtesting.backtesting.Trade.close">[docs]</a>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portion</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Place new `Order` to close `portion` of the trade at next market price.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">portion</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;portion must be a fraction between 0 and 1&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">copysign</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__size</span><span class="p">)</span> <span class="o">*</span> <span class="n">portion</span><span class="p">)),</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">__size</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">parent_trade</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__tag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span></div>


    <span class="c1"># Fields getters</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trade size (volume; negative for short trades).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">entry_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trade entry price.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entry_price</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exit_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trade exit price (or None if the trade is still active).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exit_price</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">entry_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Candlestick bar index of when the trade was entered.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entry_bar</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exit_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Candlestick bar index of when the trade was exited</span>
<span class="sd">        (or None if the trade is still active).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exit_bar</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A tag value inherited from the `Order` that opened</span>
<span class="sd">        this trade.</span>

<span class="sd">        This can be used to track trades and apply conditional</span>
<span class="sd">        logic / subgroup analysis.</span>

<span class="sd">        See also `Order.tag`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tag</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_sl_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sl_order</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_tp_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tp_order</span>

    <span class="c1"># Extra properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">entry_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Datetime of when the trade was entered.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__entry_bar</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exit_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Datetime of when the trade was exited.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exit_bar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__exit_bar</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_long</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if the trade is long (trade size is positive).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_short</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if the trade is short (trade size is negative).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_long</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trade profit (positive) or loss (negative) in cash units.&quot;&quot;&quot;</span>
        <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exit_price</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">last_price</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">*</span> <span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entry_price</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pl_pct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trade profit (positive) or loss (negative) in percent.&quot;&quot;&quot;</span>
        <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exit_price</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">last_price</span>
        <span class="k">return</span> <span class="n">copysign</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">price</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entry_price</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trade total value in cash (volume × price).&quot;&quot;&quot;</span>
        <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exit_price</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">last_price</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__size</span><span class="p">)</span> <span class="o">*</span> <span class="n">price</span>

    <span class="c1"># SL/TP management API</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop-loss price at which to close the trade.</span>

<span class="sd">        This variable is writable. By assigning it a new price value,</span>
<span class="sd">        you create or modify the existing SL order.</span>
<span class="sd">        By assigning it `None`, you cancel it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sl_order</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sl_order</span><span class="o">.</span><span class="n">stop</span>

    <span class="nd">@sl</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">sl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_contingent</span><span class="p">(</span><span class="s1">&#39;sl&#39;</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take-profit price at which to close the trade.</span>

<span class="sd">        This property is writable. By assigning it a new price value,</span>
<span class="sd">        you create or modify the existing TP order.</span>
<span class="sd">        By assigning it `None`, you cancel it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tp_order</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tp_order</span><span class="o">.</span><span class="n">limit</span>

    <span class="nd">@tp</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">tp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_contingent</span><span class="p">(</span><span class="s1">&#39;tp&#39;</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__set_contingent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;sl&#39;</span><span class="p">,</span> <span class="s1">&#39;tp&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">price</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s1">__</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s1">_order&#39;</span>
        <span class="n">order</span><span class="p">:</span> <span class="n">Order</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">order</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">price</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">}</span> <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;sl&#39;</span> <span class="k">else</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">}</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">new_order</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">trade</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span></div>



<span class="k">class</span> <span class="nc">_Broker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cash</span><span class="p">,</span> <span class="n">commission</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span>
                 <span class="n">trade_on_close</span><span class="p">,</span> <span class="n">hedging</span><span class="p">,</span> <span class="n">exclusive_orders</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">cash</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cash should be &gt;0, is </span><span class="si">{</span><span class="n">cash</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">assert</span> <span class="o">-</span><span class="mf">.1</span> <span class="o">&lt;=</span> <span class="n">commission</span> <span class="o">&lt;</span> <span class="mf">.1</span><span class="p">,</span> \
            <span class="p">(</span><span class="s2">&quot;commission should be between -10% &quot;</span>
             <span class="sa">f</span><span class="s2">&quot;(e.g. market-maker&#39;s rebates) and 10% (fees), is </span><span class="si">{</span><span class="n">commission</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">margin</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;margin should be between 0 and 1, is </span><span class="si">{</span><span class="n">margin</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="n">_Data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cash</span> <span class="o">=</span> <span class="n">cash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commission</span> <span class="o">=</span> <span class="n">commission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_leverage</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">margin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trade_on_close</span> <span class="o">=</span> <span class="n">trade_on_close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hedging</span> <span class="o">=</span> <span class="n">hedging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exclusive_orders</span> <span class="o">=</span> <span class="n">exclusive_orders</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_equity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Trade</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">Position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed_trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Trade</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;Broker: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cash</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">pl</span><span class="si">:</span><span class="s1">+.1f</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span><span class="si">}</span><span class="s1"> trades)&gt;&#39;</span>

    <span class="k">def</span> <span class="nf">new_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">sl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">tag</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="o">*</span><span class="p">,</span>
                  <span class="n">trade</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Trade</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Argument size indicates whether the order is long or short</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="n">sl</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">tp</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>

        <span class="n">is_long</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">adjusted_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adjusted_price</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_long</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sl</span> <span class="ow">or</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">limit</span> <span class="ow">or</span> <span class="n">stop</span> <span class="ow">or</span> <span class="n">adjusted_price</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">tp</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Long orders require: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;SL (</span><span class="si">{</span><span class="n">sl</span><span class="si">}</span><span class="s2">) &lt; LIMIT (</span><span class="si">{</span><span class="n">limit</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">adjusted_price</span><span class="si">}</span><span class="s2">) &lt; TP (</span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">tp</span> <span class="ow">or</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">limit</span> <span class="ow">or</span> <span class="n">stop</span> <span class="ow">or</span> <span class="n">adjusted_price</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">sl</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Short orders require: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;TP (</span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">) &lt; LIMIT (</span><span class="si">{</span><span class="n">limit</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">adjusted_price</span><span class="si">}</span><span class="s2">) &lt; SL (</span><span class="si">{</span><span class="n">sl</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">trade</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
        <span class="c1"># Put the new order in the order queue,</span>
        <span class="c1"># inserting SL/TP/trade-closing orders in-front</span>
        <span class="k">if</span> <span class="n">trade</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If exclusive orders (each new order auto-closes previous orders/position),</span>
            <span class="c1"># cancel all non-contingent orders and close all open trades beforehand</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusive_orders</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">o</span><span class="o">.</span><span class="n">is_contingent</span><span class="p">:</span>
                        <span class="n">o</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">order</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Price at the last (current) close. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">Close</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_adjusted_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Long/short `price`, adjusted for commisions.</span>
<span class="sd">        In long positions, the adjusted price is a fraction higher, and vice versa.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">price</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">copysign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commission</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">equity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cash</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">pl</span> <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">margin_available</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="c1"># From https://github.com/QuantConnect/Lean/pull/3768</span>
        <span class="n">margin_used</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_leverage</span> <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">-</span> <span class="n">margin_used</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_orders</span><span class="p">()</span>

        <span class="c1"># Log account equity for the equity curve</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_equity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">equity</span>

        <span class="c1"># If equity is negative, set all to 0 and stop the simulation</span>
        <span class="k">if</span> <span class="n">equity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_available</span> <span class="o">&lt;=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_close_trade</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">Close</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cash</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_equity</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">raise</span> <span class="n">_OutOfMoneyError</span>

    <span class="k">def</span> <span class="nf">_process_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
        <span class="nb">open</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Open</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">High</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">Low</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prev_close</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Close</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">reprocess_orders</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Process orders</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">):</span>  <span class="c1"># type: Order</span>

            <span class="c1"># Related SL/TP order was already removed</span>
            <span class="k">if</span> <span class="n">order</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Check if stop condition was hit</span>
            <span class="n">stop_price</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">stop</span>
            <span class="k">if</span> <span class="n">stop_price</span><span class="p">:</span>
                <span class="n">is_stop_hit</span> <span class="o">=</span> <span class="p">((</span><span class="n">high</span> <span class="o">&gt;</span> <span class="n">stop_price</span><span class="p">)</span> <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_long</span> <span class="k">else</span> <span class="p">(</span><span class="n">low</span> <span class="o">&lt;</span> <span class="n">stop_price</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_stop_hit</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># &gt; When the stop price is reached, a stop order becomes a market/limit order.</span>
                <span class="c1"># https://www.sec.gov/fast-answers/answersstopordhtm.html</span>
                <span class="n">order</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">stop_price</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="c1"># Determine purchase price.</span>
            <span class="c1"># Check if limit order can be filled.</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">limit</span><span class="p">:</span>
                <span class="n">is_limit_hit</span> <span class="o">=</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="n">order</span><span class="o">.</span><span class="n">limit</span> <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_long</span> <span class="k">else</span> <span class="n">high</span> <span class="o">&gt;</span> <span class="n">order</span><span class="o">.</span><span class="n">limit</span>
                <span class="c1"># When stop and limit are hit within the same bar, we pessimistically</span>
                <span class="c1"># assume limit was hit before the stop (i.e. &quot;before it counts&quot;)</span>
                <span class="n">is_limit_hit_before_stop</span> <span class="o">=</span> <span class="p">(</span><span class="n">is_limit_hit</span> <span class="ow">and</span>
                                            <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">stop_price</span> <span class="ow">or</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
                                             <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_long</span>
                                             <span class="k">else</span> <span class="n">order</span><span class="o">.</span><span class="n">limit</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">stop_price</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_limit_hit</span> <span class="ow">or</span> <span class="n">is_limit_hit_before_stop</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># stop_price, if set, was hit within this bar</span>
                <span class="n">price</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">stop_price</span> <span class="ow">or</span> <span class="nb">open</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">limit</span><span class="p">)</span>
                         <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_long</span> <span class="k">else</span>
                         <span class="nb">max</span><span class="p">(</span><span class="n">stop_price</span> <span class="ow">or</span> <span class="nb">open</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">limit</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Market-if-touched / market order</span>
                <span class="n">price</span> <span class="o">=</span> <span class="n">prev_close</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trade_on_close</span> <span class="k">else</span> <span class="nb">open</span>
                <span class="n">price</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">stop_price</span> <span class="ow">or</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
                         <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_long</span> <span class="k">else</span>
                         <span class="nb">min</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">stop_price</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>

            <span class="c1"># Determine entry/exit bar index</span>
            <span class="n">is_market_order</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">order</span><span class="o">.</span><span class="n">limit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">stop_price</span>
            <span class="n">time_index</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_market_order</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trade_on_close</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i</span>

            <span class="c1"># If order is a SL/TP order, it should close an existing trade it was contingent upon</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">parent_trade</span><span class="p">:</span>
                <span class="n">trade</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">parent_trade</span>
                <span class="n">_prev_size</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">size</span>
                <span class="c1"># If order.size is &quot;greater&quot; than trade.size, this order is a trade.close()</span>
                <span class="c1"># order and part of the trade was already closed beforehand</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">copysign</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">_prev_size</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">size</span><span class="p">)),</span> <span class="n">order</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="c1"># If this trade isn&#39;t already closed (e.g. on multiple `trade.close(.5)` calls)</span>
                <span class="k">if</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reduce_trade</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">time_index</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="o">-</span><span class="n">_prev_size</span> <span class="ow">or</span> <span class="n">trade</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span>
                <span class="k">if</span> <span class="n">order</span> <span class="ow">in</span> <span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">_sl_order</span><span class="p">,</span>
                             <span class="n">trade</span><span class="o">.</span><span class="n">_tp_order</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="o">-</span><span class="n">trade</span><span class="o">.</span><span class="n">size</span>
                    <span class="k">assert</span> <span class="n">order</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span>  <span class="c1"># Removed when trade was closed</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># It&#39;s a trade.close() order, now done</span>
                    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">_prev_size</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Else this is a stand-alone trade</span>

            <span class="c1"># Adjust price to include commission (or bid-ask spread).</span>
            <span class="c1"># In long positions, the adjusted price is a fraction higher, and vice versa.</span>
            <span class="n">adjusted_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adjusted_price</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

            <span class="c1"># If order size was specified proportionally,</span>
            <span class="c1"># precompute true size in units, accounting for margin and spread/commissions</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">size</span>
            <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">copysign</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">margin_available</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_leverage</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
                                    <span class="o">//</span> <span class="n">adjusted_price</span><span class="p">),</span> <span class="n">size</span><span class="p">)</span>
                <span class="c1"># Not enough cash/margin even for a single unit</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">size</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">assert</span> <span class="n">size</span> <span class="o">==</span> <span class="nb">round</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="n">need_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hedging</span><span class="p">:</span>
                <span class="c1"># Fill position by FIFO closing/reducing existing opposite-facing trades.</span>
                <span class="c1"># Existing trades are closed at unadjusted price, because the adjustment</span>
                <span class="c1"># was already made when buying.</span>
                <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">trade</span><span class="o">.</span><span class="n">is_long</span> <span class="o">==</span> <span class="n">order</span><span class="o">.</span><span class="n">is_long</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">assert</span> <span class="n">trade</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">order</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span>

                    <span class="c1"># Order size greater than this opposite-directed existing trade,</span>
                    <span class="c1"># so it will be closed completely</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">need_size</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_close_trade</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">time_index</span><span class="p">)</span>
                        <span class="n">need_size</span> <span class="o">+=</span> <span class="n">trade</span><span class="o">.</span><span class="n">size</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># The existing trade is larger than the new order,</span>
                        <span class="c1"># so it will only be closed partially</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_reduce_trade</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">need_size</span><span class="p">,</span> <span class="n">time_index</span><span class="p">)</span>
                        <span class="n">need_size</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">need_size</span><span class="p">:</span>
                        <span class="k">break</span>

            <span class="c1"># If we don&#39;t have enough liquidity to cover for the order, cancel it</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">need_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">adjusted_price</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_available</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_leverage</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Open a new trade</span>
            <span class="k">if</span> <span class="n">need_size</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_open_trade</span><span class="p">(</span><span class="n">adjusted_price</span><span class="p">,</span>
                                 <span class="n">need_size</span><span class="p">,</span>
                                 <span class="n">order</span><span class="o">.</span><span class="n">sl</span><span class="p">,</span>
                                 <span class="n">order</span><span class="o">.</span><span class="n">tp</span><span class="p">,</span>
                                 <span class="n">time_index</span><span class="p">,</span>
                                 <span class="n">order</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>

                <span class="c1"># We need to reprocess the SL/TP orders newly added to the queue.</span>
                <span class="c1"># This allows e.g. SL hitting in the same bar the order was open.</span>
                <span class="c1"># See https://github.com/kernc/backtesting.py/issues/119</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">sl</span> <span class="ow">or</span> <span class="n">order</span><span class="o">.</span><span class="n">tp</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">is_market_order</span><span class="p">:</span>
                        <span class="n">reprocess_orders</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">low</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">sl</span> <span class="ow">or</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">high</span> <span class="ow">or</span>
                          <span class="n">low</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">tp</span> <span class="ow">or</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">high</span><span class="p">):</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">) A contingent SL/TP order would execute in the &quot;</span>
                            <span class="s2">&quot;same bar its parent stop/limit order was turned into a trade. &quot;</span>
                            <span class="s2">&quot;Since we can&#39;t assert the precise intra-candle &quot;</span>
                            <span class="s2">&quot;price movement, the affected SL/TP order will instead be executed on &quot;</span>
                            <span class="s2">&quot;the next (matching) price/bar, making the result (of this trade) &quot;</span>
                            <span class="s2">&quot;somewhat dubious. &quot;</span>
                            <span class="s2">&quot;See https://github.com/kernc/backtesting.py/issues/119&quot;</span><span class="p">,</span>
                            <span class="ne">UserWarning</span><span class="p">)</span>

            <span class="c1"># Order processed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reprocess_orders</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_orders</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_reduce_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">:</span> <span class="n">Trade</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">time_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">trade</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="n">size_left</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">size</span>
        <span class="k">assert</span> <span class="n">size_left</span> <span class="o">*</span> <span class="n">trade</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">size_left</span><span class="p">:</span>
            <span class="n">close_trade</span> <span class="o">=</span> <span class="n">trade</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Reduce existing trade ...</span>
            <span class="n">trade</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size_left</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trade</span><span class="o">.</span><span class="n">_sl_order</span><span class="p">:</span>
                <span class="n">trade</span><span class="o">.</span><span class="n">_sl_order</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">size</span><span class="o">=-</span><span class="n">trade</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trade</span><span class="o">.</span><span class="n">_tp_order</span><span class="p">:</span>
                <span class="n">trade</span><span class="o">.</span><span class="n">_tp_order</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">size</span><span class="o">=-</span><span class="n">trade</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

            <span class="c1"># ... by closing a reduced copy of it</span>
            <span class="n">close_trade</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">_copy</span><span class="p">(</span><span class="n">size</span><span class="o">=-</span><span class="n">size</span><span class="p">,</span> <span class="n">sl_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tp_order</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">close_trade</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_close_trade</span><span class="p">(</span><span class="n">close_trade</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">time_index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_close_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">:</span> <span class="n">Trade</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">time_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trade</span><span class="o">.</span><span class="n">_sl_order</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">_sl_order</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trade</span><span class="o">.</span><span class="n">_tp_order</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">_tp_order</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">closed_trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">exit_price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="n">exit_bar</span><span class="o">=</span><span class="n">time_index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cash</span> <span class="o">+=</span> <span class="n">trade</span><span class="o">.</span><span class="n">pl</span>

    <span class="k">def</span> <span class="nf">_open_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">sl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">time_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="c1"># Create SL/TP (bracket) orders.</span>
        <span class="c1"># Make sure SL order is created first so it gets adversarially processed before TP order</span>
        <span class="c1"># in case of an ambiguous tie (both hit within a single bar).</span>
        <span class="c1"># Note, sl/tp orders are inserted at the front of the list, thus order reversed.</span>
        <span class="k">if</span> <span class="n">tp</span><span class="p">:</span>
            <span class="n">trade</span><span class="o">.</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tp</span>
        <span class="k">if</span> <span class="n">sl</span><span class="p">:</span>
            <span class="n">trade</span><span class="o">.</span><span class="n">sl</span> <span class="o">=</span> <span class="n">sl</span>


<div class="viewcode-block" id="Backtest">
<a class="viewcode-back" href="../../lucit_backtesting.html#backtesting.backtesting.Backtest">[docs]</a>
<span class="k">class</span> <span class="nc">Backtest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Backtest a particular (parameterized) strategy</span>
<span class="sd">    on particular data.</span>

<span class="sd">    Upon initialization, call method</span>
<span class="sd">    `backtesting.backtesting.Backtest.run` to run a backtest</span>
<span class="sd">    instance, or `backtesting.backtesting.Backtest.optimize` to</span>
<span class="sd">    optimize it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                 <span class="n">strategy</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Strategy</span><span class="p">],</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">cash</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span>
                 <span class="n">commission</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.0</span><span class="p">,</span>
                 <span class="n">margin</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span>
                 <span class="n">trade_on_close</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">hedging</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">exclusive_orders</span><span class="o">=</span><span class="kc">False</span>
                 <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a backtest. Requires data and a strategy to test.</span>

<span class="sd">        `data` is a `pd.DataFrame` with columns:</span>
<span class="sd">        `Open`, `High`, `Low`, `Close`, and (optionally) `Volume`.</span>
<span class="sd">        If any columns are missing, set them to what you have available,</span>
<span class="sd">        e.g.</span>

<span class="sd">            df[&#39;Open&#39;] = df[&#39;High&#39;] = df[&#39;Low&#39;] = df[&#39;Close&#39;]</span>

<span class="sd">        The passed data frame can contain additional columns that</span>
<span class="sd">        can be used by the strategy (e.g. sentiment info).</span>
<span class="sd">        DataFrame index can be either a datetime index (timestamps)</span>
<span class="sd">        or a monotonic range index (i.e. a sequence of periods).</span>

<span class="sd">        `strategy` is a `backtesting.backtesting.Strategy`</span>
<span class="sd">        _subclass_ (not an instance).</span>

<span class="sd">        `cash` is the initial cash to start with.</span>

<span class="sd">        `commission` is the commission ratio. E.g. if your broker&#39;s commission</span>
<span class="sd">        is 1% of trade value, set commission to `0.01`. Note, if you wish to</span>
<span class="sd">        account for bid-ask spread, you can approximate doing so by increasing</span>
<span class="sd">        the commission, e.g. set it to `0.0002` for commission-less forex</span>
<span class="sd">        trading where the average spread is roughly 0.2‰ of asking price.</span>

<span class="sd">        `margin` is the required margin (ratio) of a leveraged account.</span>
<span class="sd">        No difference is made between initial and maintenance margins.</span>
<span class="sd">        To run the backtest using e.g. 50:1 leverge that your broker allows,</span>
<span class="sd">        set margin to `0.02` (1 / leverage).</span>

<span class="sd">        If `trade_on_close` is `True`, market orders will be filled</span>
<span class="sd">        with respect to the current bar&#39;s closing price instead of the</span>
<span class="sd">        next bar&#39;s open.</span>

<span class="sd">        If `hedging` is `True`, allow trades in both directions simultaneously.</span>
<span class="sd">        If `False`, the opposite-facing orders first close existing trades in</span>
<span class="sd">        a `FIFO&lt;https://www.investopedia.com/terms/n/nfa-compliance-rule-2-43b.asp&gt;`__ manner.</span>

<span class="sd">        If `exclusive_orders` is `True`, each new order auto-closes the previous</span>
<span class="sd">        trade/position, making at most a single trade (long or short) in effect</span>
<span class="sd">        at each time.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="n">Strategy</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`strategy` must be a Strategy sub-type&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`data` must be a pandas.DataFrame with columns&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">commission</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`commission` must be a float value, percent of &#39;</span>
                            <span class="s1">&#39;entry order price&#39;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Convert index to datetime index</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">)</span> <span class="ow">and</span>
            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">)</span> <span class="ow">and</span>
            <span class="c1"># Numeric index with most large numbers</span>
            <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_numeric</span><span class="p">()</span> <span class="ow">and</span>
             <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;1975&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">.8</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">infer_datetime_format</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="s1">&#39;Volume&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;OHLC `data` is empty&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">intersection</span><span class="p">({</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">}))</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`data` must be a pandas.DataFrame with columns &quot;</span>
                             <span class="s2">&quot;&#39;Open&#39;, &#39;High&#39;, &#39;Low&#39;, &#39;Close&#39;, and (optionally) &#39;Volume&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Some OHLC values are missing (NaN). &#39;</span>
                             <span class="s1">&#39;Please strip those lines with `df.dropna()` or &#39;</span>
                             <span class="s1">&#39;fill them in with `df.interpolate()` or whatever.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cash</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Some prices are larger than initial cash value. Note that fractional &#39;</span>
                          <span class="s1">&#39;trading is not supported. If you want to trade Bitcoin, &#39;</span>
                          <span class="s1">&#39;increase initial cash, or trade μBTC or satoshis instead (GH-134).&#39;</span><span class="p">,</span>
                          <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_monotonic_increasing</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Data index is not sorted in ascending order. Sorting.&#39;</span><span class="p">,</span>
                          <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Data index is not datetime. Assuming simple periods, &#39;</span>
                          <span class="s1">&#39;but `pd.DateTimeIndex` is advised.&#39;</span><span class="p">,</span>
                          <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
            <span class="n">_Broker</span><span class="p">,</span> <span class="n">cash</span><span class="o">=</span><span class="n">cash</span><span class="p">,</span> <span class="n">commission</span><span class="o">=</span><span class="n">commission</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
            <span class="n">trade_on_close</span><span class="o">=</span><span class="n">trade_on_close</span><span class="p">,</span> <span class="n">hedging</span><span class="o">=</span><span class="n">hedging</span><span class="p">,</span>
            <span class="n">exclusive_orders</span><span class="o">=</span><span class="n">exclusive_orders</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Backtest.run">
<a class="viewcode-back" href="../../lucit_backtesting.html#backtesting.backtesting.Backtest.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the backtest. Returns `pd.Series` with results and statistics.</span>

<span class="sd">        Keyword arguments are interpreted as strategy parameters.</span>

<span class="sd">            &gt;&gt;&gt; Backtest(GOOG, SmaCross).run()</span>
<span class="sd">            Start                     2004-08-19 00:00:00</span>
<span class="sd">            End                       2013-03-01 00:00:00</span>
<span class="sd">            Duration                   3116 days 00:00:00</span>
<span class="sd">            Exposure Time [%]                     93.9944</span>
<span class="sd">            Equity Final [$]                      51959.9</span>
<span class="sd">            Equity Peak [$]                       75787.4</span>
<span class="sd">            Return [%]                            419.599</span>
<span class="sd">            Buy &amp; Hold Return [%]                 703.458</span>
<span class="sd">            Return (Ann.) [%]                      21.328</span>
<span class="sd">            Volatility (Ann.) [%]                 36.5383</span>
<span class="sd">            Sharpe Ratio                         0.583718</span>
<span class="sd">            Sortino Ratio                         1.09239</span>
<span class="sd">            Calmar Ratio                         0.444518</span>
<span class="sd">            Max. Drawdown [%]                    -47.9801</span>
<span class="sd">            Avg. Drawdown [%]                    -5.92585</span>
<span class="sd">            Max. Drawdown Duration      584 days 00:00:00</span>
<span class="sd">            Avg. Drawdown Duration       41 days 00:00:00</span>
<span class="sd">            # Trades                                   65</span>
<span class="sd">            Win Rate [%]                          46.1538</span>
<span class="sd">            Best Trade [%]                         53.596</span>
<span class="sd">            Worst Trade [%]                      -18.3989</span>
<span class="sd">            Avg. Trade [%]                        2.35371</span>
<span class="sd">            Max. Trade Duration         183 days 00:00:00</span>
<span class="sd">            Avg. Trade Duration          46 days 00:00:00</span>
<span class="sd">            Profit Factor                         2.08802</span>
<span class="sd">            Expectancy [%]                        8.79171</span>
<span class="sd">            SQN                                  0.916893</span>
<span class="sd">            Kelly Criterion                        0.6134</span>
<span class="sd">            _strategy                            SmaCross</span>
<span class="sd">            _equity_curve                           Eq...</span>
<span class="sd">            _trades                       Size  EntryB...</span>
<span class="sd">            dtype: object</span>

<span class="sd">        .. warning::</span>
<span class="sd">            You may obtain different results for different strategy parameters.</span>
<span class="sd">            E.g. if you use 50- and 200-bar SMA, the trading simulation will</span>
<span class="sd">            begin on bar 201. The actual length of delay is equal to the lookback</span>
<span class="sd">            period of the `Strategy.I` indicator which lags the most.</span>
<span class="sd">            Obviously, this can affect results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_Data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">broker</span><span class="p">:</span> <span class="n">_Broker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="n">strategy</span><span class="p">:</span> <span class="n">Strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span><span class="p">(</span><span class="n">broker</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="n">strategy</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>  <span class="c1"># Strategy.init might have changed/added to data.df</span>

        <span class="c1"># Indicators used in Strategy.next()</span>
        <span class="n">indicator_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="n">indicator</span>
                           <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">strategy</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                           <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">_Indicator</span><span class="p">)}</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

        <span class="c1"># Skip first few candles where indicators are still &quot;warming up&quot;</span>
        <span class="c1"># +1 to have at least two entries available</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">max</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">indicator</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                         <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">indicator_attrs</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Disable &quot;invalid value encountered in ...&quot; warnings. Comparison</span>
        <span class="c1"># np.nan &gt;= 3 is not invalid; it&#39;s False.</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)):</span>
                <span class="c1"># Prepare data and indicators for `next` call</span>
                <span class="n">data</span><span class="o">.</span><span class="n">_set_length</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">indicator_attrs</span><span class="p">:</span>
                    <span class="c1"># Slice indicator on the last dimension (case of 2d indicator)</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">indicator</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

                <span class="c1"># Handle orders processing and broker stuff</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">broker</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">_OutOfMoneyError</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c1"># Next tick, a moment before bar close</span>
                <span class="n">strategy</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Close any remaining open trades so they produce some stats</span>
                <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">broker</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
                    <span class="n">trade</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="c1"># Re-run broker one last time to handle orders placed in the last strategy</span>
                <span class="c1"># iteration. Use the same OHLC values as in the last broker iteration.</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">):</span>
                    <span class="n">try_</span><span class="p">(</span><span class="n">broker</span><span class="o">.</span><span class="n">next</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">_OutOfMoneyError</span><span class="p">)</span>

            <span class="c1"># Set data back to full length</span>
            <span class="c1"># for future `indicator._opts[&#39;data&#39;].index` calls to work</span>
            <span class="n">data</span><span class="o">.</span><span class="n">_set_length</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">))</span>

            <span class="n">equity</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">broker</span><span class="o">.</span><span class="n">_equity</span><span class="p">)</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">broker</span><span class="o">.</span><span class="n">_cash</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="n">compute_stats</span><span class="p">(</span>
                <span class="n">trades</span><span class="o">=</span><span class="n">broker</span><span class="o">.</span><span class="n">closed_trades</span><span class="p">,</span>
                <span class="n">equity</span><span class="o">=</span><span class="n">equity</span><span class="p">,</span>
                <span class="n">ohlc_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
                <span class="n">risk_free_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">strategy_instance</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span></div>


<div class="viewcode-block" id="Backtest.optimize">
<a class="viewcode-back" href="../../lucit_backtesting.html#backtesting.backtesting.Backtest.optimize">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">maximize</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;SQN&#39;</span><span class="p">,</span>
                 <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;grid&#39;</span><span class="p">,</span>
                 <span class="n">max_tries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">constraint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">return_heatmap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">return_optimization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">random_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                                    <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span>
                                    <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimize strategy parameters to an optimal combination.</span>
<span class="sd">        Returns result `pd.Series` of the best run.</span>

<span class="sd">        `maximize` is a string key from the</span>
<span class="sd">        `backtesting.backtesting.Backtest.run`-returned results series,</span>
<span class="sd">        or a function that accepts this series object and returns a number;</span>
<span class="sd">        the higher the better. By default, the method maximizes</span>
<span class="sd">        Van Tharp&#39;s `System Quality Number&lt;https://google.com/search?q=System+Quality+Number&gt;`__.</span>

<span class="sd">        `method` is the optimization method. Currently two methods are supported:</span>

<span class="sd">        * `&quot;grid&quot;` which does an exhaustive (or randomized) search over the</span>
<span class="sd">          cartesian product of parameter combinations, and</span>
<span class="sd">        * `&quot;skopt&quot;` which finds close-to-optimal strategy parameters using</span>
<span class="sd">          `model-based optimization&lt;https://scikit-optimize.github.io/stable/auto_examples/bayesian-optimization.html&gt;`__</span>
<span class="sd">          , making at most `max_tries` evaluations.</span>

<span class="sd">        `max_tries` is the maximal number of strategy runs to perform.</span>
<span class="sd">        If `method=&quot;grid&quot;`, this results in randomized grid search.</span>
<span class="sd">        If `max_tries` is a floating value between (0, 1], this sets the</span>
<span class="sd">        number of runs to approximately that fraction of full grid space.</span>
<span class="sd">        Alternatively, if integer, it denotes the absolute maximum number</span>
<span class="sd">        of evaluations. If unspecified (default), grid search is exhaustive,</span>
<span class="sd">        whereas for `method=&quot;skopt&quot;`, `max_tries` is set to 200.</span>

<span class="sd">        `constraint` is a function that accepts a dict-like object of</span>
<span class="sd">        parameters (with values) and returns `True` when the combination</span>
<span class="sd">        is admissible to test with. By default, any parameters combination</span>
<span class="sd">        is considered admissible.</span>

<span class="sd">        If `return_heatmap` is `True`, besides returning the result</span>
<span class="sd">        series, an additional `pd.Series` is returned with a multiindex</span>
<span class="sd">        of all admissible parameter combinations, which can be further</span>
<span class="sd">        inspected or projected onto 2D to plot a heatmap</span>
<span class="sd">        (see `backtesting.lib.plot_heatmaps()`).</span>

<span class="sd">        If `return_optimization` is True and `method = &#39;skopt&#39;`,</span>
<span class="sd">        in addition to result series (and maybe heatmap), return raw</span>
<span class="sd">        [`scipy.optimize.OptimizeResult`]</span>
<span class="sd">        `OptimizeResult&lt;https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.OptimizeResult.html&gt;`__ for</span>
<span class="sd">        further inspection, e.g. with `scikit-optimize&lt;https://scikit-optimize.github.io&gt;`__\</span>
<span class="sd">        `plotting tools&lt;https://scikit-optimize.github.io/stable/modules/plots.html&gt;`__.</span>

<span class="sd">        If you want reproducible optimization results, set `random_state`</span>
<span class="sd">        to a fixed integer random seed.</span>

<span class="sd">        Additional keyword arguments represent strategy arguments with</span>
<span class="sd">        list-like collections of possible values. For example, the following</span>
<span class="sd">        code finds and returns the &quot;best&quot; of the 7 admissible (of the</span>
<span class="sd">        9 possible) parameter combinations:</span>

<span class="sd">            backtest.optimize(sma1=[5, 10, 15], sma2=[10, 20, 40],</span>
<span class="sd">                              constraint=lambda p: p.sma1 &lt; p.sma2)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO:</span>
        <span class="c1">#   - Improve multiprocessing/parallel execution on Windos with start method &#39;spawn&#39;.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Need some strategy parameters to optimize&#39;</span><span class="p">)</span>

        <span class="n">maximize_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">maximize</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">maximize_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">maximize</span><span class="p">)</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">maximize</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`maximize`, if str, must match a key in pd.Series &#39;</span>
                                 <span class="s1">&#39;result of backtest.run()&#39;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">maximize</span><span class="p">(</span><span class="n">stats</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">_key</span><span class="o">=</span><span class="n">maximize</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">stats</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">maximize</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`maximize` must be str (a field of backtest.run() result &#39;</span>
                            <span class="s1">&#39;Series) or a function that accepts result Series &#39;</span>
                            <span class="s1">&#39;and returns a number; the higher the better&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">callable</span><span class="p">(</span><span class="n">maximize</span><span class="p">),</span> <span class="n">maximize</span>

        <span class="n">have_constraint</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">constraint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">constraint</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">constraint</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`constraint` must be a function that accepts a dict &quot;</span>
                            <span class="s2">&quot;of strategy parameters and returns a bool whether &quot;</span>
                            <span class="s2">&quot;the combination of parameters is admissible or not&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">callable</span><span class="p">(</span><span class="n">constraint</span><span class="p">),</span> <span class="n">constraint</span>

        <span class="k">if</span> <span class="n">return_optimization</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;skopt&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;return_optimization=True only valid if method=&#39;skopt&#39;&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_tuple</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">x</span><span class="p">,)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimization variable &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39; is passed no &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;optimization values: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">AttrDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
            <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">_grid_size</span><span class="p">():</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">10_000</span> <span class="ow">and</span> <span class="n">have_constraint</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                                                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
                           <span class="k">if</span> <span class="n">constraint</span><span class="p">(</span><span class="n">AttrDict</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">size</span>

        <span class="k">def</span> <span class="nf">_optimize_grid</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]]:</span>
            <span class="n">rand</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span><span class="o">.</span><span class="n">random</span>
            <span class="n">grid_frac</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">max_tries</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span>
                         <span class="n">max_tries</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">max_tries</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">else</span>
                         <span class="n">max_tries</span> <span class="o">/</span> <span class="n">_grid_size</span><span class="p">())</span>
            <span class="n">param_combos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>  <span class="c1"># back to dict so it pickles</span>
                            <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="p">(</span><span class="n">AttrDict</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                                           <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                                                                   <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
                            <span class="k">if</span> <span class="n">constraint</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                            <span class="ow">and</span> <span class="n">rand</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">grid_frac</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">param_combos</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No admissible parameter combinations to test&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_combos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Searching for best of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">param_combos</span><span class="p">)</span><span class="si">}</span><span class="s1"> configurations.&#39;</span><span class="p">,</span>
                              <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">heatmap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                <span class="n">name</span><span class="o">=</span><span class="n">maximize_key</span><span class="p">,</span>
                                <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_combos</span><span class="p">],</span>
                                    <span class="n">names</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">param_combos</span><span class="p">))</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

            <span class="k">def</span> <span class="nf">_batch</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">),</span> <span class="n">n</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span>

            <span class="c1"># Save necessary objects into &quot;global&quot; state; pass into concurrent executor</span>
            <span class="c1"># (and thus pickle) nothing but two numbers; receive nothing but numbers.</span>
            <span class="c1"># With start method &quot;fork&quot;, children processes will inherit parent address space</span>
            <span class="c1"># in a copy-on-write manner, achieving better performance/RAM benefit.</span>
            <span class="n">backtest_uuid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
            <span class="n">param_batches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_batch</span><span class="p">(</span><span class="n">param_combos</span><span class="p">))</span>
            <span class="n">Backtest</span><span class="o">.</span><span class="n">_mp_backtests</span><span class="p">[</span><span class="n">backtest_uuid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_batches</span><span class="p">,</span> <span class="n">maximize</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If multiprocessing start method is &#39;fork&#39; (i.e. on POSIX), use</span>
                <span class="c1"># a pool of processes to compute results in parallel.</span>
                <span class="c1"># Otherwise (i.e. on Windos), sequential computation will be &quot;faster&quot;.</span>
                <span class="k">if</span> <span class="n">mp</span><span class="o">.</span><span class="n">get_start_method</span><span class="p">(</span><span class="n">allow_none</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;fork&#39;</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                        <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">Backtest</span><span class="o">.</span><span class="n">_mp_task</span><span class="p">,</span> <span class="n">backtest_uuid</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_batches</span><span class="p">))]</span>
                        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">_tqdm</span><span class="p">(</span><span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">futures</span><span class="p">),</span>
                                            <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Backtest.optimize&#39;</span><span class="p">):</span>
                            <span class="n">batch_index</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">param_batches</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]):</span>
                                <span class="n">heatmap</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;posix&#39;</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;For multiprocessing support in `Backtest.optimize()` &quot;</span>
                                      <span class="s2">&quot;set multiprocessing start method to &#39;fork&#39;.&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">batch_index</span> <span class="ow">in</span> <span class="n">_tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_batches</span><span class="p">))):</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">Backtest</span><span class="o">.</span><span class="n">_mp_task</span><span class="p">(</span><span class="n">backtest_uuid</span><span class="p">,</span> <span class="n">batch_index</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">param_batches</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]):</span>
                            <span class="n">heatmap</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">Backtest</span><span class="o">.</span><span class="n">_mp_backtests</span><span class="p">[</span><span class="n">backtest_uuid</span><span class="p">]</span>

            <span class="n">best_params</span> <span class="o">=</span> <span class="n">heatmap</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">best_params</span><span class="p">):</span>
                <span class="c1"># No trade was made in any of the runs. Just make a random</span>
                <span class="c1"># run so we get some, if empty, results</span>
                <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">param_combos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">heatmap</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="n">best_params</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">return_heatmap</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">stats</span><span class="p">,</span> <span class="n">heatmap</span>
            <span class="k">return</span> <span class="n">stats</span>

        <span class="k">def</span> <span class="nf">_optimize_skopt</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                                       <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span>
                                       <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">skopt</span> <span class="kn">import</span> <span class="n">forest_minimize</span>
                <span class="kn">from</span> <span class="nn">skopt.callbacks</span> <span class="kn">import</span> <span class="n">DeltaXStopper</span>
                <span class="kn">from</span> <span class="nn">skopt.learning</span> <span class="kn">import</span> <span class="n">ExtraTreesRegressor</span>
                <span class="kn">from</span> <span class="nn">skopt.space</span> <span class="kn">import</span> <span class="n">Categorical</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Real</span>
                <span class="kn">from</span> <span class="nn">skopt.utils</span> <span class="kn">import</span> <span class="n">use_named_args</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Need package &#39;scikit-optimize&#39; for method=&#39;skopt&#39;. &quot;</span>
                                  <span class="s2">&quot;pip install scikit-optimize&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>

            <span class="k">nonlocal</span> <span class="n">max_tries</span>
            <span class="n">max_tries</span> <span class="o">=</span> <span class="p">(</span><span class="mi">200</span> <span class="k">if</span> <span class="n">max_tries</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span>
                         <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_tries</span> <span class="o">*</span> <span class="n">_grid_size</span><span class="p">()))</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">max_tries</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">else</span>
                         <span class="n">max_tries</span><span class="p">)</span>

            <span class="n">dimensions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s1">&#39;mM&#39;</span><span class="p">:</span>  <span class="c1"># timedelta, datetime64</span>
                    <span class="c1"># these dtypes are unsupported in skopt, so convert to raw int</span>
                    <span class="c1"># TODO: save dtype and convert back later</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s1">&#39;iumM&#39;</span><span class="p">:</span>
                    <span class="n">dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Integer</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">high</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
                    <span class="n">dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Real</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">high</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Categorical</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="s1">&#39;onehot&#39;</span><span class="p">))</span>

            <span class="c1"># Avoid recomputing re-evaluations:</span>
            <span class="c1"># &quot;The objective has been evaluated at this point before.&quot;</span>
            <span class="c1"># https://github.com/scikit-optimize/scikit-optimize/issues/302</span>
            <span class="n">memoized_run</span> <span class="o">=</span> <span class="n">lru_cache</span><span class="p">()(</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">tup</span><span class="p">)))</span>

            <span class="c1"># np.inf/np.nan breaks sklearn, np.finfo(float).max breaks skopt.plots.plot_objective</span>
            <span class="n">INVALID</span> <span class="o">=</span> <span class="mf">1e300</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">_tqdm</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="n">max_tries</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Backtest.optimize&#39;</span><span class="p">))</span>

            <span class="nd">@use_named_args</span><span class="p">(</span><span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">objective_function</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">):</span>
                <span class="nb">next</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
                <span class="c1"># Check constraints</span>
                <span class="c1"># TODO: Adjust after https://github.com/scikit-optimize/scikit-optimize/pull/971</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">constraint</span><span class="p">(</span><span class="n">AttrDict</span><span class="p">(</span><span class="n">params</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="n">INVALID</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">memoized_run</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
                <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">maximize</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">INVALID</span>
                <span class="k">return</span> <span class="n">value</span>

            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                    <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;The objective has been evaluated at this point before.&#39;</span><span class="p">)</span>

                <span class="n">res</span> <span class="o">=</span> <span class="n">forest_minimize</span><span class="p">(</span>
                    <span class="n">func</span><span class="o">=</span><span class="n">objective_function</span><span class="p">,</span>
                    <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">,</span>
                    <span class="n">n_calls</span><span class="o">=</span><span class="n">max_tries</span><span class="p">,</span>
                    <span class="n">base_estimator</span><span class="o">=</span><span class="n">ExtraTreesRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                    <span class="n">acq_func</span><span class="o">=</span><span class="s1">&#39;LCB&#39;</span><span class="p">,</span>
                    <span class="n">kappa</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">n_initial_points</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">max_tries</span><span class="p">,</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)),</span>
                    <span class="n">initial_point_generator</span><span class="o">=</span><span class="s1">&#39;lhs&#39;</span><span class="p">,</span>  <span class="c1"># &#39;sobel&#39; requires n_initial_points ~ 2**N</span>
                    <span class="n">callback</span><span class="o">=</span><span class="n">DeltaXStopper</span><span class="p">(</span><span class="mf">9e-7</span><span class="p">),</span>
                    <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>

            <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)))</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">stats</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">return_heatmap</span><span class="p">:</span>
                <span class="n">heatmap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">x_iters</span><span class="p">),</span> <span class="o">-</span><span class="n">res</span><span class="o">.</span><span class="n">func_vals</span><span class="p">)),</span>
                                    <span class="n">name</span><span class="o">=</span><span class="n">maximize_key</span><span class="p">)</span>
                <span class="n">heatmap</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">heatmap</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">[</span><span class="n">heatmap</span> <span class="o">!=</span> <span class="o">-</span><span class="n">INVALID</span><span class="p">]</span>
                <span class="n">heatmap</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">heatmap</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">return_optimization</span><span class="p">:</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">func_vals</span> <span class="o">!=</span> <span class="n">INVALID</span>
                <span class="n">res</span><span class="o">.</span><span class="n">x_iters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x_iters</span><span class="p">,</span> <span class="n">valid</span><span class="p">))</span>
                <span class="n">res</span><span class="o">.</span><span class="n">func_vals</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">func_vals</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">stats</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">_optimize_grid</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;skopt&#39;</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">_optimize_skopt</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Method should be &#39;grid&#39; or &#39;skopt&#39;, not </span><span class="si">{</span><span class="n">method</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_mp_task</span><span class="p">(</span><span class="n">backtest_uuid</span><span class="p">,</span> <span class="n">batch_index</span><span class="p">):</span>
        <span class="n">bt</span><span class="p">,</span> <span class="n">param_batches</span><span class="p">,</span> <span class="n">maximize_func</span> <span class="o">=</span> <span class="n">Backtest</span><span class="o">.</span><span class="n">_mp_backtests</span><span class="p">[</span><span class="n">backtest_uuid</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">batch_index</span><span class="p">,</span> <span class="p">[</span><span class="n">maximize_func</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span> <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;# Trades&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                             <span class="k">for</span> <span class="n">stats</span> <span class="ow">in</span> <span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
                                           <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">param_batches</span><span class="p">[</span><span class="n">batch_index</span><span class="p">])]</span>

    <span class="n">_mp_backtests</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="s1">&#39;Backtest&#39;</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Backtest.plot">
<a class="viewcode-back" href="../../lucit_backtesting.html#backtesting.backtesting.Backtest.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">plot_equity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_return</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_pl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">plot_volume</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_drawdown</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_trades</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">smooth_equity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">relative_equity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">superimpose</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">resample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reverse_indicators</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">show_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">open_browser</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the progression of the last backtest run.</span>

<span class="sd">        If `results` is provided, it should be a particular result</span>
<span class="sd">        `pd.Series` such as returned by</span>
<span class="sd">        `backtesting.backtesting.Backtest.run` or</span>
<span class="sd">        `backtesting.backtesting.Backtest.optimize`, otherwise the last</span>
<span class="sd">        run&#39;s results are used.</span>

<span class="sd">        `filename` is the path to save the interactive HTML plot to.</span>
<span class="sd">        By default, a strategy/parameter-dependent file is created in the</span>
<span class="sd">        current working directory.</span>

<span class="sd">        `plot_width` is the width of the plot in pixels. If None (default),</span>
<span class="sd">        the plot is made to span 100% of browser width. The height is</span>
<span class="sd">        currently non-adjustable.</span>

<span class="sd">        If `plot_equity` is `True`, the resulting plot will contain</span>
<span class="sd">        an equity (initial cash plus assets) graph section. This is the same</span>
<span class="sd">        as `plot_return` plus initial 100%.</span>

<span class="sd">        If `plot_return` is `True`, the resulting plot will contain</span>
<span class="sd">        a cumulative return graph section. This is the same</span>
<span class="sd">        as `plot_equity` minus initial 100%.</span>

<span class="sd">        If `plot_pl` is `True`, the resulting plot will contain</span>
<span class="sd">        a profit/loss (P/L) indicator section.</span>

<span class="sd">        If `plot_volume` is `True`, the resulting plot will contain</span>
<span class="sd">        a trade volume section.</span>

<span class="sd">        If `plot_drawdown` is `True`, the resulting plot will contain</span>
<span class="sd">        a separate drawdown graph section.</span>

<span class="sd">        If `plot_trades` is `True`, the stretches between trade entries</span>
<span class="sd">        and trade exits are marked by hash-marked tractor beams.</span>

<span class="sd">        If `smooth_equity` is `True`, the equity graph will be</span>
<span class="sd">        interpolated between fixed points at trade closing times,</span>
<span class="sd">        unaffected by any interim asset volatility.</span>

<span class="sd">        If `relative_equity` is `True`, scale and label equity graph axis</span>
<span class="sd">        with return percent, not absolute cash-equivalent values.</span>

<span class="sd">        If `superimpose` is `True`, superimpose larger-timeframe candlesticks</span>
<span class="sd">        over the original candlestick chart. Default downsampling rule is:</span>
<span class="sd">        monthly for daily data, daily for hourly data, hourly for minute data,</span>
<span class="sd">        and minute for (sub-)second data.</span>
<span class="sd">        `superimpose` can also be a valid</span>
<span class="sd">        `Pandas offset string&lt;https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#dateoffset-objects&gt;`__</span>
<span class="sd">        , such as `&#39;5T&#39;` or `&#39;5min&#39;`, in which case this frequency will be</span>
<span class="sd">        used to superimpose.</span>
<span class="sd">        Note, this only works for data with a datetime index.</span>

<span class="sd">        If `resample` is `True`, the OHLC data is resampled in a way that</span>
<span class="sd">        makes the upper number of candles for Bokeh to plot limited to 10_000.</span>
<span class="sd">        This may, in situations of overabundant data,</span>
<span class="sd">        improve plot&#39;s interactive performance and avoid browser&#39;s</span>
<span class="sd">        `Javascript Error: Maximum call stack size exceeded` or similar.</span>
<span class="sd">        Equity &amp; dropdown curves and individual trades data is,</span>
<span class="sd">        likewise, [reasonably _aggregated_] `TRADES_AGG&lt;lib.html#backtesting.lib.TRADES_AGG&gt;`__.</span>
<span class="sd">        `resample` can also be a</span>
<span class="sd">        `Pandas offset string&lt;https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#dateoffset-objects&gt;`__</span>
<span class="sd">        , such as `&#39;5T&#39;` or `&#39;5min&#39;`, in which case this frequency will be</span>
<span class="sd">        used to resample, overriding above numeric limitation.</span>
<span class="sd">        Note, all this only works for data with a datetime index.</span>

<span class="sd">        If `reverse_indicators` is `True`, the indicators below the OHLC chart</span>
<span class="sd">        are plotted in reverse order of declaration.</span>

<span class="sd">        If `show_legend` is `True`, the resulting plot graphs will contain</span>
<span class="sd">        labeled legends.</span>

<span class="sd">        If `open_browser` is `True`, the resulting `filename` will be</span>
<span class="sd">        opened in the default web browser.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;First issue `backtest.run()` to obtain results.&#39;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span>

        <span class="k">return</span> <span class="n">plot</span><span class="p">(</span>
            <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
            <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
            <span class="n">indicators</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">_strategy</span><span class="o">.</span><span class="n">_indicators</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
            <span class="n">plot_width</span><span class="o">=</span><span class="n">plot_width</span><span class="p">,</span>
            <span class="n">plot_equity</span><span class="o">=</span><span class="n">plot_equity</span><span class="p">,</span>
            <span class="n">plot_return</span><span class="o">=</span><span class="n">plot_return</span><span class="p">,</span>
            <span class="n">plot_pl</span><span class="o">=</span><span class="n">plot_pl</span><span class="p">,</span>
            <span class="n">plot_volume</span><span class="o">=</span><span class="n">plot_volume</span><span class="p">,</span>
            <span class="n">plot_drawdown</span><span class="o">=</span><span class="n">plot_drawdown</span><span class="p">,</span>
            <span class="n">plot_trades</span><span class="o">=</span><span class="n">plot_trades</span><span class="p">,</span>
            <span class="n">smooth_equity</span><span class="o">=</span><span class="n">smooth_equity</span><span class="p">,</span>
            <span class="n">relative_equity</span><span class="o">=</span><span class="n">relative_equity</span><span class="p">,</span>
            <span class="n">superimpose</span><span class="o">=</span><span class="n">superimpose</span><span class="p">,</span>
            <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">,</span>
            <span class="n">reverse_indicators</span><span class="o">=</span><span class="n">reverse_indicators</span><span class="p">,</span>
            <span class="n">show_legend</span><span class="o">=</span><span class="n">show_legend</span><span class="p">,</span>
            <span class="n">open_browser</span><span class="o">=</span><span class="n">open_browser</span><span class="p">)</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo">
                <div style="text-align: center;">
                    <a href="https://www.lucit.tech"><img src="https://www.lucit.tech/files/images/logos/LUCIT-LOGO.png"></a><br>
                    <a href="https://shop.lucit.services/software/unicorn-binance-suite" style="font-size: 0.85em;font-weight: 900">Get a UNICORN Binance Suite License!</a><br>
                    <br>
                    <a href="https://github.com/LUCIT-Systems-and-Development" target="_blank" style="text-decoration:none;"><img src="../../_static/icons8-github-20.png"></a>
                    <a href="https://fb.me/lucit.systems.and.development" target="_blank" style="text-decoration:none;"><img src="../../_static/icons8-facebook-20.png"></a>
                    <a href="https://twitter.com/LUCIT_SysDev" target="_blank" style="text-decoration:none;"><img src="../../_static/icons8-twitter-20.png"></a>
                    <a href="https://www.linkedin.com/company/lucit-systems-and-development" target="_blank" style="text-decoration:none;"><img src="../../_static/icons8-linkedin-20.png"></a>
                    <a href="https://www.xing.com/pages/lucit-systems-and-development" target="_blank" style="text-decoration:none;"><img src="../../_static/icons8-xing-20.png"></a>
                    <a href="https://medium.lucit.tech" target="_blank" style="text-decoration:none;"><img src="../../_static/icons8-medium-monogram-20.png"></a>
                    <a href="https://www.youtube.com/channel/UCp57u8vaPqEWQTlfpYn-KnQ" target="_blank" style="text-decoration:none;"><img src="../../_static/icons8-youtube-20.png"></a>
                </div>
            </p>
<div id="searchbox" style="display: block" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<div role="note" aria-label="source code">
    <h3>GitHub</h3>
    <ul class="this-page-menu">
      <li><a href="https://github.com/LUCIT-Systems-and-Development/lucit-backtesting">Show Source</a></li>
      
<li>
<a class="github-button" href="https://github.com/LUCIT-Systems-and-Development/lucit-backtesting"
   data-icon="octicon-star" data-show-count="true"
   aria-label="Star LUCIT-Systems-and-Development/lucit-backtesting on GitHub">Star</a>
<br />
<a class="github-button" href="https://github.com/LUCIT-Systems-and-Development/lucit-backtesting/subscription"
   data-icon="octicon-eye" data-show-count="true"
   aria-label="Watch LUCIT-Systems-and-Development/lucit-backtesting on GitHub">Watch</a>
<br />
<a class="github-button" href="https://github.com/LUCIT-Systems-and-Development/lucit-backtesting/fork"
   data-icon="octicon-repo-forked" data-show-count="true"
   aria-label="Fork LUCIT-Systems-and-Development/lucit-backtesting on GitHub">Fork</a>
<br />
<a class="github-button" href="https://github.com/LUCIT-Systems-and-Development/lucit-backtesting/issues"
   data-icon="octicon-issue-opened"
   data-show-count="true" aria-label="Issue LUCIT-Systems-and-Development/lucit-backtesting on GitHub">Issue</a>
    
</li>

    </ul>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>  
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
              
                  
                  
              <li><img src="../../_static/lucit.png" alt="LUCIT Logo"
                       style="vertical-align: middle; margin-top: -1px"/></li>
              <li><a href="https://docs.lucit.tech">Docs Index</a> | </li>
              <li><a href="https://www.lucit.tech/lucit-backtesting.html">lucit-backtesting</a> &#187;</li>
                  
              
              
              <a href="../../index.html">Docs</a> &#187;
              
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">backtesting.backtesting</a></li>
                <li class="right">
                    

    <div class="inline-search" role="search">
        <form class="inline-search" action="../../search.html" method="get">
          <input placeholder="Quick search" aria-label="Quick search" type="text" name="q" />
          <input type="submit" value="Go" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </form>
    </div>
                     |
                </li>
            
      </ul>
    </div>  
    <div class="footer">
    <a href="https://docs.lucit.tech">Index of all LUCIT Software Documentation</a><br />
    &copy; <a href="/license.html">Copyright</a> 2024-2024, LUCIT Systems and Development. All Rights Reserved..
    See <a href="/license.html">License</a> for more information.<br />
    Last updated on Jun 07 2024 at 09:28 (CET).
    <a href="https://github.com/LUCIT-Systems-and-Development/lucit-backtesting/issues/new/choose">Found a bug</a>?
    <br />
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
        with <a href="https://github.com/LUCIT-Systems-and-Development/python-docs-theme-lucit">python-docs-theme-lucit</a>
        by <a href="https://www.lucit.tech">LUCIT Systems and Development</a>.
    </div>
    
    <img referrerpolicy="no-referrer-when-downgrade" src="https://webmon.lucit.services/matomo.php?idsite=11&amp;rec=1" style="border:0" alt="" />
    

  </body>
</html>